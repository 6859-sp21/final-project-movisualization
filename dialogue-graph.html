<html>
  <head>
    <!-- Load d3.js -->
    <link rel="stylesheet" href="web.css">
    <script src="https://d3js.org/d3.v6.js"></script>
  </head>
    <div style="float:left">
      <body>
        <h2> Distribution of female lines per movie </h2>
        <div id="tabs" style="margin: auto; width:45%;">
          <button class="tablinks" id ="adventure">Adventure</button>
          <button class="tablinks" id ="action">Action</button>
          <button class="tablinks" id ="drama">Drama</button>
          <button class="tablinks" id ="comedy">Comedy</button>
          <button class="tablinks" id ="romance">Romance</button>
          <button class="tablinks" id ="all">All Genres</button>
        </div>
    </div>
    <!-- <div id="chart" style="width:420px;height:420px;"> -->
      <!-- This is where we will put our chart. -->
    <!-- </div> -->
    <div style = "float: right;">
      <h2>Gender Distribution in Top 8 Credit's Positions</h1>
      <p>In movies, the higher the credit's position of an actor the higher the pay is (1 being high - 8 being low)</p>
  
      <div id="chart2" style="width:420px;height:420px;">
        <!-- This is where we will put our chart. -->
      </div>
    </div>

    <style>


div.tooltip {
      color: black;
      position: absolute;
      text-align: left;
      width: auto;
      height: auto;
      padding: 5px;
      font-family: Futura;
      font: 12px sans-serif ;
      background: #FCB8C3FF;
      border: 0px;
      border-radius: 8px;
      pointer-events: none;
    }
    .selected {
      fill: #E6B0F1;
    }
    </style>

    <script> 
      d3.csv("data_cleaned_merged/movie_title_metadata.csv").then((movie_data) =>{d3.csv("data_cleaned_merged/line_percents_by_gender.csv").then((data) => {
        movie_dictionnary = new Map()
        movie_data.forEach(function(d){
          genres = d.genres.slice(1, -1)
          genres = new Set(genres.split("'"))
          movie_dictionnary.set(d.title,genres)
        })
        data.forEach(function(d){
          if(movie_dictionnary.has(d.Title)){
            let g = ""
            movie_dictionnary.get(d.Title).forEach(function(m){
              g+= m
              if(m.length >= 2){
                g+= ", "
              }
              
            })
            g = g.slice(0,-2)
            d.genre =g
          }
        })
        const all_data = data
        //genre tabbing 
        document.getElementById("action").onclick = function(){selectGenre("action")};
        document.getElementById("adventure").onclick = function(){selectGenre("adventure")};
        document.getElementById("drama").onclick = function(){selectGenre("drama")};
        document.getElementById("comedy").onclick = function(){selectGenre("comedy")};
        document.getElementById("romance").onclick = function(){selectGenre("romance")};
        document.getElementById("all").onclick = function(){selectGenre("all")};
        function selectGenre(g){
          if(g == "all"){
            data = all_data
          }else{
          data = all_data.filter(d=>{
            if(movie_dictionnary.has(d.Title)){
              if(movie_dictionnary.get(d.Title).has(g)){
                return d;
              }
            }else{
              console.log("error: movie not in genre dictionnary:  " + d.Title);
            
            }
          })}
          update();
        }

       
        
        // SVG setup
        const margin = {top: 10, right: 10, bottom: 30, left: 30},
        width = 1000 - margin.left - margin.right,
        height = 300 - margin.top - margin.bottom;

        const svg = d3.select("body")
        .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform",
                  `translate(${margin.left}, ${margin.top})`);
        // Setup scales
        const x = d3.scaleLinear()
          .domain([0.0, 100.0])
          .range([margin.left, width - margin.right])
          .nice();

        const nbins = 100;
        const tooltip = d3.select("body")
          .append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        const t = d3.transition()
              .duration(1000);
         
        // }
        var color = d3.scaleLinear().domain([1,100]).range(["#f5d6b0", "#619ba5"])
        // Function for graph
        function update(){
          //histogram binning
          const histogram = d3.histogram()
            .domain(x.domain())
            .thresholds(x.ticks(nbins))
            .value(function(d) { return (d.Female_Percent)*100;} )

          //binning data and filtering out empty bins
          const bins = histogram(data).filter(d => d.length>0)

          //g container for each bin
          let binContainer = svg.selectAll(".gBin")
            .data(bins);
          binContainer.exit().remove()

          let binContainerEnter = binContainer.enter()
            .append("g")
              .attr("class", "gBin")
              .attr("transform", d => `translate(${x(d.x0)}, ${height})`)

          //need to populate the bin containers with data the first time
          binContainerEnter.selectAll("circle")
              .data(d => d.map((p, i) => {
                return {idx: i,
                        name: p.Title,
                        value_f: parseInt((p.Female_Percent)*100),
                        value: parseInt((p.Male_Percent)*100),
                        radius: (x(d.x1)-x(d.x0))/2,
                        genre: p.genre
                      }
              }))
            .enter()
            .append("circle")
            .attr("fill", function(d){
                return color(d.value_f)
              })
              .attr("class", "enter")
              .attr("cx", 0) //g element already at correct x pos
              .attr("cy", function(d) {
                  return - d.idx * 2 * d.radius - d.radius; })
              .attr("r", 0)
              .on("mouseover", tooltipOn)
              .on("mouseout", tooltipOff)
              .transition()
                .duration(500)
                .attr("r", function(d) {
                return (d.length==0) ? 0 : d.radius; })
          
          binContainerEnter.merge(binContainer)
              .attr("transform", d => `translate(${x(d.x0)}, ${height})`)
          //enter/update/exit for circles, inside each container
          let dots = binContainer.selectAll("circle")
              .data(d => d.map((p, i) => {
                return {idx: i,
                        name: p.Title,
                        value_f: parseInt((p.Female_Percent)*100),
                        value: parseInt((p.Male_Percent)*100),
                        radius: (x(d.x1)-x(d.x0))/2,
                        genre: p.genre
                      }
              }))
          
          // //EXIT old elements not present in data
          dots.exit()
              .attr("class", "exit")
            .transition()
            .duration(1000)
              .attr("r", 0)
              .remove();

          //UPDATE old elements present in new data.
          dots.attr("class", "update");

          // ENTER new elements present in new data.
          dots.enter()
            .append("circle")
              .attr("class", "enter")
              .attr("fill", function(d){
                return color(d.value_f)
              })
              .attr("cx", 0) //g element already at correct x pos
              .attr("cy", function(d) {
                return - d.idx * 2 * d.radius - d.radius; })
              .attr("r", 0)
            .merge(dots)
              .on("mouseover", tooltipOn)
              .on("mouseout", tooltipOff)
              .transition()
                .duration(500)
                .attr("r", function(d) {
                return (d.length==0) ? 0 : d.radius; })
      // });
      };

        function tooltipOn(d) {
          //x position of parent g element
          let gParent = d3.select(this.parentElement)
          let translateValue = gParent.attr("transform")

          let gX = translateValue.split(",")[0].split("(")[1]
          let gY = height + (+d3.select(this).attr("cy")-50)

          d3.select(this)
            .classed("selected", true)
          tooltip.transition()
              .duration(200)
              .style("opacity", .9);
          tooltip.html(d.target.__data__.name + "<br/> Male Lines: " + d.target.__data__.value + "% <br/> Female Lines: " + d.target.__data__.value_f+"% <br/> Genres: " +d.target.__data__.genre)
            .style("left", gX + "px")
            .style("top", gY + "px");
        }//tooltipOn

        function tooltipOff(d) {
          d3.select(this)
              .classed("selected", false);
            tooltip.transition()
                .duration(500)
                .style("opacity", 0);
        }//tooltipOff

        svg.append("g")
        // .attr("class", "axis axis--x")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));

        update();

      // update with new data every 3sec
      // d3.interval(function() {
      //   update();
      // }, 3000);

        // document.getElementById("chart").appendChild(svg.node());
    });
  });
    // positions graph
    d3.csv("data_cleaned_merged/movie_lines_with_all_metadata.csv").then((allData) => {
      //genre tabbing 
      document.getElementById("action").onclick = function(){selectGenre("action")};
        document.getElementById("adventure").onclick = function(){selectGenre("adventure")};
        document.getElementById("drama").onclick = function(){selectGenre("drama")};
        document.getElementById("comedy").onclick = function(){selectGenre("comedy")};
        document.getElementById("romance").onclick = function(){selectGenre("romance")};
        document.getElementById("all").onclick = function(){selectGenre("all")};
        function selectGenre(g){
          if(g == "all"){
            allData = allData
          }else{
            allData = allData.filter(d=> {
              let genres = d["Genres"].slice(1, -1);
              genres = genres.split("'");
              genres = genres.filter(genre => genre === g);
              if(genres.length === 1){
                return d;
              }
            })
          }
          update();
        }

      update();
      function update(){
        let oldChild = null
        if(document.getElementById("chart2") !== null){
          oldChild = document.getElementById("chart2").lastElementChild;
        }
        // format data for positions graph 
        // array of 2 arrays of objects: {position: # (1-8), gender: 'f'/'m', percentage: #(female/male percentage at position #), start: (where bar should start), end: (where bar should end), total: #(people at position #)}
        // first array is of females, second is of males
        data = [[],[]]
        for(let i = 0; i<8; i++){
            data[0].push({
                position: i+1, 
                gender: 'f',
                percentage: 0, 
                start: -0.5,
                end: 0,
                total: 0
            });
            data[1].push({
                position: i+1, 
                gender: 'm',
                percentage: 0, 
                start: 0,
                end: 0.5,
                total: 0
            });
        }

        // filter out all data that isn't top 8 and get totals for female, male, and overall
        allData = allData.filter(d => {
            let pos = d["Position_in_Credits"];
            if(pos<9){
                if(d["Gender"] == 'f'){
                    data[0][pos-1].percentage += 1;
                }else{
                    data[1][pos-1].percentage += 1;
                }
                data[0][pos-1].total += 1;
                data[1][pos-1].total += 1;
                return d;
            }
        });
        
        // get percentage and set start (left) and end (right) of bars
        data[0] = data[0].map(d => {
            d.percentage /= d.total;
            d.end = -0.5+d.percentage;
            return d;
        })
        data[1] = data[1].map(d => {
            d.percentage /= d.total;
            d.start = 0.5-d.percentage;
            return d;
        })
        
        // Setting up variables that describe our chart's space.
        const height = 400;
        const width = 500;;
        const margin = ({top: 20, right: 10, bottom: 20, left: 30});
        const color = d3.scaleOrdinal()
        .domain(['m','f'])
        .range(['#f5d6b0','#619ba5'])

        // Create a SVG we will use to make our chart.
        const svg = d3.create('svg')
          .attr('width', width)
          .attr('height', height);

        // Setting up scales for xAxis and yAxis
        const x = d3.scaleLinear()
          .domain([-0.5, 0.5])
          .range([margin.left, width - margin.right]);

        const y = d3.scaleBand()
          .domain([1, 2, 3, 4, 5, 6, 7, 8])
          .range([margin.top, height - margin.bottom])
          .padding([0.2]);
      
        // bars 
        svg.append('g')
        .selectAll("g")
            .data(data)
            .join("g")
            .attr("fill", d => color(d[0].gender))
            .selectAll("rect")
            .data(d => d.map(v => Object.assign(v, {key: d.position})))
            .join("rect")
            .attr("x", d => x(d.start))
            .attr("y", d => y(d.position))
            .attr("width", d => x(d.end) - x(d.start))
            .attr("height", y.bandwidth())

        
        //Drawing our x-axis
        xAxis = svg.append('g')
        .attr('transform', `translate(0, ${margin.top})`)
        .call(d3.axisTop(x).tickSize(0).tickFormat(d => {
            if(d*100 == 0){
                return "50%" // `${d*100}%`
            }}))


        // Drawing our y-axis
        yAxis = svg.append('g')
          .attr('transform', `translate(${x(0)}, 0)`)
          .call(d3.axisLeft(y))
          .call(g => g.selectAll(".tick")
          .data(data[0])
          .attr('transform', d => `translate(${x(-1.08)},${y(d.position) + y.bandwidth() / 2})`))

        // document.getElementById("chart2").appendChild(svg.node());
        if(oldChild === null){
          document.getElementById("chart2").appendChild(svg.node());
        }else{
          document.getElementById("chart2").replaceChild(svg.node(), oldChild);
        }
      }
  });
</script>
</body>

<!-- This adapted from Arvind's observable from lecture. https://observablehq.com/d/4c93c3a516d35624 -->
<!-- Great D3 intro resource: https://observablehq.com/@d3/learn-d3?collection=@d3/learn-d3 -->
</html>