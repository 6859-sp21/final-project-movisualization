<html>
  <head>
    <link rel="stylesheet" href="web.css">
    <script src="https://d3js.org/d3.v6.js"></script>

  </head>
  <body>
    <h1 id="movie">Movie</h1>
    <div id="chart" style="width:620px;height:620px;">
    </div>
    <style>
    div.tooltip {
        color: black;
        position: absolute;
        text-align: left;
        width: auto;
        height: auto;
        padding: 5px;
        font-family: Futura;
        font: 12px sans-serif ;
        background: #FCB8C3FF;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
        }
    </style>

    <script>
    d3.csv("data_cleaned_merged/conversation_gender_splits.csv").then((allData) => {
        allData.forEach(function(d){
            d.Movie = d.Title
            d.id = +d.MovieID.substring(1)
            d.Year = +d.Year
            d.Conversation = +d.Conv_ID.substring(1)
            d.F_Percent = +d.Percent_Female*100
            d.M_Percent = +d.Percent_Male*-100;
        })
        window.addEventListener('storage', function(e) {  
          document.getElementById("movie").innerHTML = localStorage["movie"]
         
          //update
          update();
        });   
        function update(){
          let oldChild = null
          if(document.getElementById("chart") !== null){
            oldChild = document.getElementById("chart").lastElementChild;
          }
          var movie = localStorage["movie"]
          // console.log(movie)

          data_by_movie = allData.filter(d => {
            if (d.Movie == movie){
              return d;
            }
          })
          data_by_movie.forEach(function(d){
              d.Movie = d.Title
              d.id = +d.MovieID.substring(1)
              d.Year = +d.Year
              d.Conversation = +d.Conv_ID.substring(1)
              d.F_Percent = +d.Percent_Female*100
              d.M_Percent = +d.Percent_Male*100;
          })

          for (i=0; i<data_by_movie.length; i++){
            data_by_movie[i].position = i
          }
          console.log(data_by_movie)
          

  
          // var fMax = Math.max(20, d3.max(data_by_movie, function(d){return d.F_Percent}));
          // var mMax = Math.max(20, d3.max(data_by_movie, function(d){return d.M_Percent}));

          const height = 300;
          const width = 1000;;
          const margin = ({top: 10, right: 10, bottom: 20, left: 30});
          var color = d3.scaleOrdinal()
              .domain(['m','f'])
              .range(['#f5d6b0','#619ba5'])

          const svg = d3.create('svg')
              .attr('width', width)
              .attr('height', height*2);

          const xScale = d3.scaleBand()
            .domain(d3.range(0, data_by_movie.length))
            .range([margin.left, width - margin.right])
            .padding([0.2])
          // .nice();

          var xSubgroup = d3.scaleBand()
              .domain(['m', 'f'])
            .range([0, xScale.bandwidth()])
            .padding([0.05])

          const yScaleF = d3.scaleLinear()
            .domain([0, 100])
            .range([(height - margin.bottom)/2, margin.top])
            .nice();

          const yScaleM = d3.scaleLinear()
            .domain([0,100])
            .range([(height - margin.bottom)/2, height - margin.bottom])
            .nice();

          
          // const yScaleFA = d3.scaleLinear()
          //   .domain([0, 100])
          //   .range([height - margin.bottom, margin.top])
          //   .nice();

          // const yScaleMA = d3.scaleLinear()
          //   .domain([0,100])
          //   .range([(height - margin.bottom), height*2 - margin.bottom])
          //   .nice();

          // Drawing x-axis
          // svg.append('g')
          // .attr('transform', `translate(0, ${height - margin.bottom})`)
          // .tickValues([])

          // Drawing y-axis
          svg.append('g')
            .attr('transform', `translate(${margin.left}, 0)`)
            .call(d3.axisLeft(yScaleF))

          svg.append('g')
            .attr('transform', `translate(${margin.left}, 0)`)
            .call(d3.axisLeft(yScaleM))

          var tooltip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0)

          svg.append("g")
            .selectAll("g")
            .data(data_by_movie)
            .enter()
            .append("g")
            .attr("transform", function(d) {return "translate(" + xScale(d.position) + ",0)"; })
            .selectAll("rect")
            .data(function(d) {
              a = [{key: 'm', value: d.M_Percent, conv: d.Conversation}, {key:'f', value:d.F_Percent, conv: d.Conversation}]
              return a})
            .enter().append("rect")
              // .attr("x", function(d) { return xSubgroup(d.key); })
              .attr("y", function(d) {
                console.log(yScaleM(d.value))
                // return yScale(d.value);
                if (d.key=='m'){ return (height - margin.bottom)/2}
                else{return yScaleF(d.value);}
              })
              .attr("width", xSubgroup.bandwidth())
              .attr("height", function(d) { 
                if(d.key=='m'){ return Math.abs((height - margin.bottom)/2 - yScaleM(d.value)); }
                else{return (height - margin.bottom)/2 - yScaleF(d.value); }
              })
              .attr("fill", function(d) { return color(d.key); })
              .on("mouseover", function(event, d){
                  tooltip.transition()
                  .duration(200)
                  .style("opacity", .9)
                  tooltip.html(function(){
                    if(d.key === 'm'){
                      return "Male Percent: " + parseInt(d.value) +"%" + '\n' + "Conversation: " + parseInt(d.conv)
                    }else{
                      return "Female Percent: " + parseInt(d.value)+"%" + '\n' + "Conversation: " + parseInt(d.conv)
                    }
                  })
                    .style("left", (event.pageX) + "px")
                    .style("top", (event.pageY - 28) + "px");
              })
              .on("mouseout", function(event, d) {
                  tooltip.transition()
                  .duration(500)
                  .style("opacity", 0);
              })
          document.getElementById("chart").appendChild(svg.node());

        if(oldChild === null){
          document.getElementById("chart").appendChild(svg.node());
        }else{
          document.getElementById("chart").replaceChild(svg.node(), oldChild);
        }
        };
        
    });
    </script>
</body>
</html>