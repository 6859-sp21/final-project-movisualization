<html>
  <head>
    <link rel="stylesheet" href="web.css">
    <script src="https://d3js.org/d3.v6.js"></script>

  </head>
  <body>
    <h1 id="movie">Movie</h1>
    <div id="chart" style="width:620px;height:620px;">
    </div>
    <style>
    div.tooltip {
        color: black;
        position: absolute;
        text-align: left;
        width: auto;
        height: auto;
        padding: 5px;
        font-family: Futura;
        font: 12px sans-serif ;
        background: #FCB8C3FF;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
        }
    </style>

    <script>
    d3.csv("data_cleaned_merged/conversation_gender_splits.csv").then((allData) => {
        allData.forEach(function(d){
            d.Movie = d.Title
            d.id = +d.MovieID.substring(1)
            d.Year = +d.Year
            d.Conversation = +d.Conv_ID.substring(1)
            d.F_Percent = +d.Percent_Female*100
            d.M_Percent = +d.Percent_Male*100;
        })
        window.addEventListener('storage', function(e) {  
          document.getElementById("movie").innerHTML = localStorage["movie"]
          //update
        });   
        var movie = '10 things i hate about you';

        data_by_movie = allData.filter(d => {
          if (d.Movie == movie){
            return d;
          }
        })

        data_by_movie.forEach(function(d){
            d.Movie = d.Title
            d.id = +d.MovieID.substring(1)
            d.Year = +d.Year
            d.Conversation = +d.Conv_ID.substring(1)
            d.F_Percent = +d.Percent_Female*100
            d.M_Percent = +d.Percent_Male*100;
        })
        var conversations = []
        for (i=0; i<data_by_movie.length; i++){
          // conversations.push(+data_by_movie[i].Conversation)
          data_by_movie[i].position = i
        }
        // conversations.sort(d3.ascending)
        console.log(data_by_movie)
        

        

      
        var fMax = Math.max(20, d3.max(data_by_movie, function(d){return d.F_Percent}));
        var mMax = Math.max(20, d3.max(data_by_movie, function(d){return d.M_Percent}));

        const height = 300;
        const width = 1000;;
        const margin = ({top: 10, right: 10, bottom: 20, left: 30});
        var color = d3.scaleOrdinal()
            .domain(['m','f'])
            .range(['#f5d6b0','#619ba5'])

        const svg = d3.create('svg')
            .attr('width', width)
            .attr('height', height);

        const xScale = d3.scaleBand()
          .domain(d3.range(0, d3.max(data_by_movie, function(d){return d.Conversation})))
          .range([margin.left, width - margin.right])
          .padding([0.2])
         // .nice();

         var xSubgroup = d3.scaleBand()
            .domain(['m', 'f'])
          .range([0, xScale.bandwidth()])
          .padding([0.05])

        const yScale = d3.scaleLinear()
          .domain([0, 100])
          .range([height - margin.bottom, margin.top])
          .nice();

        var tooltip = d3.select("body").append("div")
          .attr("class", "tooltip")
          .style("opacity", 0)

        svg.append("g")
          .selectAll("g")
          .data(data_by_movie)
          .enter()
          .append("g")
          .attr("transform", function(d) {return "translate(" + xScale(d.position) + ",0)"; })
          .selectAll("rect")
          .data(function(d) {
            a = [{key: 'm', value: d.M_Percent, conv: d.Conversation}, {key:'f', value:d.F_Percent, conv: d.Conversation}]
             return a})
           .enter().append("rect")
            .attr("x", function(d) { return xSubgroup(d.key); })
            .attr("y", function(d) { return yScale(d.value); })
             .attr("width", xSubgroup.bandwidth())
            .attr("height", function(d) { return height - margin.bottom- yScale(d.value); })
            .attr("fill", function(d) { return color(d.key); })
            .on("mouseover", function(event, d){
                tooltip.transition()
                .duration(200)
                .style("opacity", .9)
                tooltip.html(function(){
                  if(d.key === 'm'){
                    return "Male Percent: " + parseInt(d.value) +"%" + '\n' + "Conversation: " + parseInt(d.conv)
                  }else{
                    return "Female Percent: " + parseInt(d.value)+"%" + '\n' + "Conversation: " + parseInt(d.conv)
                  }
                })
                  .style("left", (event.pageX) + "px")
                  .style("top", (event.pageY - 28) + "px");
             })
            .on("mouseout", function(event, d) {
                tooltip.transition()
                .duration(500)
                .style("opacity", 0);
            })
        document.getElementById("chart").appendChild(svg.node());
    });
    </script>
</body>
</html>